<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Passport Photo Sheet Maker Pro</title>
  <link href="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #4361ee;
      --primary-hover: #3a56d4;
      --secondary-color: #f8f9fa;
      --text-color: #2b2d42;
      --light-text: #6c757d;
      --border-color: #e9ecef;
      --success-color: #4cc9f0;
      --warning-color: #f8961e;
      --danger-color: #f94144;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 6px 12px rgba(0, 0, 0, 0.15);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f8f9fa;
      color: var(--text-color);
      line-height: 1.6;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .container {
      background-color: white;
      border-radius: 12px;
      box-shadow: var(--shadow-md);
      overflow: hidden;
      margin-bottom: 30px;
    }

    header {
      background: linear-gradient(135deg, var(--primary-color), #3a0ca3);
      color: white;
      padding: 25px;
      text-align: center;
      border-radius: 12px 12px 0 0;
    }

    h1 {
      font-weight: 600;
      font-size: 32px;
      margin-bottom: 5px;
    }

    .subtitle {
      font-weight: 300;
      font-size: 16px;
      opacity: 0.9;
    }

    .app-content {
      display: flex;
      flex-direction: column;
      padding: 25px;
    }

    .instructions {
      background-color: var(--secondary-color);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 25px;
      border-left: 4px solid var(--primary-color);
      position: relative;
    }

    .instructions h3 {
      color: var(--primary-color);
      margin-bottom: 10px;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .instructions ol {
      padding-left: 20px;
    }

    .instructions li {
      margin-bottom: 8px;
      position: relative;
      padding-left: 10px;
    }

    .instructions li:before {
      content: "•";
      color: var(--primary-color);
      font-weight: bold;
      position: absolute;
      left: 0;
    }

    .workflow {
      display: flex;
      flex-direction: column;
      gap: 25px;
    }

    .panel {
      background-color: white;
      border-radius: 8px;
      box-shadow: var(--shadow);
      padding: 25px;
      border: 1px solid var(--border-color);
    }

    .panel-title {
      font-size: 20px;
      font-weight: 500;
      margin-bottom: 20px;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }

    .panel-title svg {
      width: 24px;
      height: 24px;
    }

    .control-group {
      margin: 15px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
    }

    .btn {
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 500;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      box-shadow: var(--shadow);
    }

    .btn:hover {
      background-color: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .btn:disabled {
      background-color: #adb5bd;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background-color: #6c757d;
    }

    .btn-secondary:hover {
      background-color: #5a6268;
    }

    .btn-success {
      background-color: var(--success-color);
    }

    .btn-success:hover {
      background-color: #3db5d8;
    }

    .btn-warning {
      background-color: var(--warning-color);
    }

    .btn-warning:hover {
      background-color: #e07d0e;
    }

    .btn-danger {
      background-color: var(--danger-color);
    }

    .btn-danger:hover {
      background-color: #e03131;
    }

    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
      border-radius: 8px;
      box-shadow: var(--shadow);
    }

    .file-input-wrapper input[type="file"] {
      font-size: 100px;
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
    }

    .file-input-label {
      padding: 14px 24px;
      background-color: var(--primary-color);
      color: white;
      border-radius: 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s;
      font-size: 16px;
    }

    .file-input-label:hover {
      background-color: var(--primary-hover);
    }

    .color-picker-wrapper {
      display: flex;
      align-items: center;
      gap: 15px;
      background-color: var(--secondary-color);
      padding: 15px;
      border-radius: 8px;
      box-shadow: var(--shadow);
    }

    .color-picker-label {
      font-size: 16px;
      color: var(--text-color);
      font-weight: 500;
    }

    input[type="color"] {
      width: 50px;
      height: 50px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      box-shadow: var(--shadow);
    }

    .size-info {
      font-size: 14px;
      color: var(--light-text);
      margin-top: 8px;
      font-style: italic;
    }

    /* Color Balance Controls */
    .color-balance-controls {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 20px;
      padding: 20px;
      background-color: var(--secondary-color);
      border-radius: 8px;
      box-shadow: var(--shadow);
    }

    .balance-slider {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .balance-slider label {
      min-width: 120px;
      font-size: 15px;
      font-weight: 500;
    }

    .balance-slider input[type="range"] {
      flex-grow: 1;
      height: 8px;
      -webkit-appearance: none;
      background: var(--border-color);
      border-radius: 4px;
      box-shadow: var(--shadow);
    }

    .balance-slider input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      background: var(--primary-color);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .balance-value {
      min-width: 40px;
      text-align: center;
      font-size: 15px;
      font-weight: 500;
      background-color: white;
      padding: 5px 10px;
      border-radius: 4px;
      box-shadow: var(--shadow);
    }

    .reset-balance {
      margin-top: 15px;
      align-self: flex-start;
      padding: 8px 16px;
      font-size: 14px;
    }

    /* Color Curve Control */
    .color-curves-controls {
      margin-top: 20px;
      padding: 20px;
      background-color: var(--secondary-color);
      border-radius: 8px;
      box-shadow: var(--shadow);
    }

    .curve-container {
      margin-bottom: 20px;
    }

    .curve-title {
      font-weight: 500;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 16px;
    }

    .curve-wrapper {
      position: relative;
      width: 1in;
      height: 1in;
      border: 1px solid var(--border-color);
      background-color: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--shadow);
      margin: 0 auto;
    }

    .curve-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      cursor: crosshair;
    }

    .curve-grid {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    /* Preview Section */
    #previewContainer {
      display: none;
      margin-top: 25px;
      animation: fadeIn 0.5s ease;
    }

    .preview-image-container {
      margin: 0 auto;
      max-width: 600px;
      background-color: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-color);
    }

    #cropImage {
      max-width: 100%;
      max-height: 500px;
      display: block;
      margin: 0 auto;
      border-radius: 8px;
      box-shadow: var(--shadow);
    }

    .preview-controls {
      margin-top: 25px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
    }

    .zoom-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 15px 0;
      background-color: var(--secondary-color);
      padding: 10px 15px;
      border-radius: 8px;
      box-shadow: var(--shadow);
    }

    .zoom-controls button {
      padding: 8px 16px;
      min-width: 40px;
      font-weight: bold;
    }

    #zoomLevel {
      min-width: 60px;
      text-align: center;
      font-weight: 500;
      background-color: white;
      padding: 5px 10px;
      border-radius: 4px;
      box-shadow: var(--shadow);
    }

    /* Canvas Section */
    .canvas-section {
      margin-top: 35px;
      animation: fadeIn 0.5s ease;
    }

    .canvas-container {
      width: 6in;
      height: 4in;
      background: white;
      border: 1px solid var(--border-color);
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: 15px;
      padding: 15px;
      box-sizing: border-box;
      margin: 25px auto;
      box-shadow: var(--shadow-md);
      border-radius: 12px;
    }

    .photo-slot {
      border: 2px solid #000 !important;
      background-color: white;
      padding: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      border-radius: 4px;
      box-shadow: var(--shadow);
      position: relative;
    }

    .photo-slot:hover {
      border-color: var(--primary-color);
      transform: scale(1.02);
      box-shadow: var(--shadow-md);
    }

    .photo-slot img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 2px;
    }

    .download-section {
      text-align: center;
      margin-top: 25px;
    }

    /* Loading Spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    /* Watermark */
    .watermark {
      position: fixed;
      bottom: 20px;
      left: 0;
      right: 0;
      text-align: center;
      background-color: rgba(255,255,255,0.9);
      padding: 10px;
      font-size: 14px;
      z-index: 1000;
      animation: fadeIn 1s ease-in;
      border-top: 1px solid #ddd;
    }

    /* Donation Popup Styles */
    .donation-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      border-radius: 12px;
      box-shadow: var(--shadow-md);
      padding: 30px;
      max-width: 400px;
      width: 90%;
      z-index: 2000;
      text-align: center;
      animation: fadeIn 0.3s ease;
      border: 1px solid var(--border-color);
    }

    .donation-popup h3 {
      color: var(--primary-color);
      margin-bottom: 15px;
      font-size: 22px;
    }

    .donation-popup p {
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .donation-amounts {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin: 20px 0;
    }

    .donation-amount {
      background-color: var(--primary-color);
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      font-weight: 500;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
    }

    .donation-amount:hover {
      background-color: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .donation-amount.underline-blue {
      text-decoration: underline;
      text-decoration-color: blue;
      color: blue;
    }

    .donation-upi {
      background-color: var(--secondary-color);
      padding: 12px;
      border-radius: 8px;
      font-weight: 500;
      margin: 20px 0;
      word-break: break-all;
      border-left: 4px solid var(--primary-color);
    }

    .close-popup {
      background-color: var(--secondary-color);
      color: var(--text-color);
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      margin-top: 15px;
    }

    .close-popup:hover {
      background-color: #e9ecef;
    }

    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      animation: fadeIn 0.3s ease;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .canvas-container {
        width: 100%;
        height: auto;
        aspect-ratio: 6/4;
      }
      
      .preview-controls {
        gap: 10px;
      }
      
      .btn {
        padding: 10px 18px;
        font-size: 15px;
      }

      .panel-title {
        font-size: 18px;
      }

      .donation-popup {
        padding: 20px;
      }
    }

    @media (max-width: 480px) {
      .control-group {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .preview-controls {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
        justify-content: center;
      }
      
      .balance-slider {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .balance-slider input[type="range"] {
        width: 100%;
      }

      header {
        padding: 20px 15px;
      }

      h1 {
        font-size: 26px;
      }

      .watermark {
        font-size: 12px;
        padding: 8px;
      }

      .donation-amounts {
        flex-direction: column;
        align-items: center;
      }

      .donation-amount {
        width: 100%;
      }
    }

    /* Icons */
    .icon {
      width: 20px;
      height: 20px;
      fill: currentColor;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Passport Photo Sheet Maker Pro</h1>
      <div class="subtitle">Create professional passport photos</div>
    </header>

    <div class="app-content">
      <div class="instructions">
        <h3>
          <svg class="icon" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
          </svg>
          How to create your passport photos
        </h3>
        <ol>
          <li><strong>Upload</strong> your photo using the button below</li>
          <li><strong>Crop and adjust</strong> your photo using the editing tools</li>
          <li>Adjust <strong>color balance</strong> and <strong>color curve</strong> if needed</li>
          <li>Select a <strong>background color</strong> (usually white or off-white)</li>
          <li>Click <strong>"Generate Photo Sheet"</strong> to create your passport photos</li>
          <li><strong>Download</strong> your ready-to-print photo sheet</li>
        </ol>
      </div>

      <div class="workflow">
        <div class="panel">
          <h3 class="panel-title">
            <svg class="icon" viewBox="0 0 24 24">
              <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
            </svg>
            Step 1: Upload Your Photo
          </h3>
          <div class="control-group">
            <div class="file-input-wrapper">
              <label class="file-input-label">
                <svg class="icon" viewBox="0 0 24 24">
                  <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
                Choose Image
                <input type="file" id="upload" accept="image/*">
              </label>
            </div>
          </div>
        </div>

        <div class="panel">
          <h3 class="panel-title">
            <svg class="icon" viewBox="0 0 24 24">
              <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/>
              <path d="M17.99 9l-1.41-1.42-6.59 6.59-2.58-2.57-1.42 1.41 4 3.99z"/>
            </svg>
            Step 2: Customize Your Photo
          </h3>
          <div class="control-group">
            <div class="color-picker-wrapper">
              <span class="color-picker-label">Background Color:</span>
              <input type="color" id="bgColorPicker" value="#ffffff">
            </div>
          </div>
          
          <div class="color-balance-controls">
            <h4>Color Balance Adjustments</h4>
            <div class="balance-slider">
              <label for="redBalance">Red/Cyan:</label>
              <input type="range" id="redBalance" min="-100" max="100" value="0">
              <span class="balance-value" id="redValue">0</span>
            </div>
            <div class="balance-slider">
              <label for="greenBalance">Green/Magenta:</label>
              <input type="range" id="greenBalance" min="-100" max="100" value="0">
              <span class="balance-value" id="greenValue">0</span>
            </div>
            <div class="balance-slider">
              <label for="blueBalance">Blue/Yellow:</label>
              <input type="range" id="blueBalance" min="-100" max="100" value="0">
              <span class="balance-value" id="blueValue">0</span>
            </div>
            <button class="btn btn-secondary reset-balance" onclick="resetColorBalance()">
              <svg class="icon" viewBox="0 0 24 24">
                <path d="M12 5V2L8 6l4 4V7c3.31 0 6 2.69 6 6 0 2.97-2.17 5.43-5 5.91v2.02c3.95-.49 7-3.85 7-7.93 0-4.42-3.58-8-8-8zm-6 8c0-1.65.67-3.15 1.76-4.24L6.34 7.34C4.9 8.79 4 10.79 4 13c0 4.08 3.05 7.44 7 7.93v-2.02c-2.83-.48-5-2.94-5-5.91z"/>
              </svg>
              Reset Balance
            </button>
          </div>

          <div class="color-curves-controls">
            <h4>Color Curve</h4>
            <div class="curve-container">
              <div class="curve-title">
                <svg class="icon" viewBox="0 0 24 24" width="18" height="18">
                  <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14z"/>
                </svg>
                RGB Curve
              </div>
              <div class="curve-wrapper">
                <canvas id="rgbGrid" class="curve-grid"></canvas>
                <canvas id="rgbCurve" class="curve-canvas"></canvas>
              </div>
              <button class="btn btn-secondary" onclick="resetCurve('rgb')">
                <svg class="icon" viewBox="0 0 24 24">
                  <path d="M12 5V2L8 6l4 4V7c3.31 0 6 2.69 6 6 0 2.97-2.17 5.43-5 5.91v2.02c3.95-.49 7-3.85 7-7.93 0-4.42-3.58-8-8-8zm-6 8c0-1.65.67-3.15 1.76-4.24L6.34 7.34C4.9 8.79 4 10.79 4 13c0 4.08 3.05 7.44 7 7.93v-2.02c-2.83-.48-5-2.94-5-5.91z"/>
                </svg>
                Reset Curve
              </button>
            </div>
          </div>
        </div>

        <div id="previewContainer">
          <div class="preview-image-container">
            <img id="cropImage"><br>
            <div class="zoom-controls">
              <button class="btn" onclick="zoomOut()">
                <svg class="icon" viewBox="0 0 24 24">
                  <path d="M19 13H5v-2h14v2z"/>
                </svg>
              </button>
              <span id="zoomLevel">100%</span>
              <button class="btn" onclick="zoomIn()">
                <svg class="icon" viewBox="0 0 24 24">
                  <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
              </button>
            </div>
            <div class="preview-controls">
              <button class="btn" onclick="rotateLeft()">
                <svg class="icon" viewBox="0 0 24 24">
                  <path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"/>
                </svg>
                Rotate Left
              </button>
              <button class="btn" onclick="rotateRight()">
                <svg class="icon" viewBox="0 0 24 24">
                  <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                </svg>
                Rotate Right
              </button>
              <button class="btn btn-success" onclick="useCropped()">
                <svg class="icon" viewBox="0 0 24 24">
                  <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                </svg>
                Generate Photo Sheet
              </button>
              <button class="btn btn-warning" onclick="removeBackground()">
                <svg class="icon" viewBox="0 0 24 24">
                  <path d="M19 4h-3.5l-1-1h-5l-1 1H5v2h14zM6 7v12c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6z"/>
                </svg>
                Remove Background
              </button>
            </div>
          </div>
        </div>

        <div class="canvas-section">
          <h3 class="panel-title">
            <svg class="icon" viewBox="0 0 24 24">
              <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14z"/>
            </svg>
            Your Passport Photo Sheet
          </h3>
          <div class="canvas-container" id="photoCanvas"></div>
          <div class="download-section">
            <button class="btn" onclick="download()">
              <svg class="icon" viewBox="0 0 24 24">
                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
              </svg>
              Download Photo Sheet
            </button>
            <div class="size-info" id="sizeInfo">Standard 6x4 inches sheet with 8 passport photos (300 DPI)</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    const upload = document.getElementById('upload');
    const cropImage = document.getElementById('cropImage');
    const previewContainer = document.getElementById('previewContainer');
    const photoCanvas = document.getElementById('photoCanvas');
    const sizeInfo = document.getElementById('sizeInfo');
    let cropper;
    let originalImageData = null;

    // Default specifications (3.5 x 4.5 cm)
    const defaultSpecs = { width: 3.5, height: 4.5 };

    // Color balance elements
    const redBalance = document.getElementById('redBalance');
    const greenBalance = document.getElementById('greenBalance');
    const blueBalance = document.getElementById('blueBalance');
    const redValue = document.getElementById('redValue');
    const greenValue = document.getElementById('greenValue');
    const blueValue = document.getElementById('blueValue');

    // Curve elements
    const curveCanvases = {
      rgb: document.getElementById('rgbCurve')
    };

    const gridCanvases = {
      rgb: document.getElementById('rgbGrid')
    };

    // Curve data
    const curves = {
      rgb: { points: [{x: 0, y: 0}, {x: 255, y: 255}], color: 'black' }
    };

    // Initialize curve canvases
    function initCurveCanvases() {
      // Draw grids first
      Object.keys(gridCanvases).forEach(channel => {
        drawGrid(gridCanvases[channel]);
      });
      
      // Then draw curves
      Object.keys(curveCanvases).forEach(channel => {
        drawCurve(channel);
        setupCurveEditing(channel);
      });
    }

    // Draw grid on canvas
    function drawGrid(canvas) {
      const ctx = canvas.getContext('2d');
      const width = canvas.width = canvas.offsetWidth;
      const height = canvas.height = canvas.offsetHeight;
      
      // Clear canvas
      ctx.clearRect(0, 0, width, height);
      
      // Draw grid
      ctx.strokeStyle = '#e0e0e0';
      ctx.lineWidth = 1;
      
      // Vertical grid lines
      for (let x = 0; x <= width; x += width / 10) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, height);
        ctx.stroke();
      }
      
      // Horizontal grid lines
      for (let y = 0; y <= height; y += height / 10) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(width, y);
        ctx.stroke();
      }
      
      // Draw axes
      ctx.strokeStyle = '#999';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(0, height);
      ctx.lineTo(width, height);
      ctx.lineTo(width, 0);
      ctx.stroke();
    }

    // Draw a curve on canvas
    function drawCurve(channel) {
      const canvas = curveCanvases[channel];
      const ctx = canvas.getContext('2d');
      const width = canvas.width = canvas.offsetWidth;
      const height = canvas.height = canvas.offsetHeight;
      
      // Clear canvas
      ctx.clearRect(0, 0, width, height);
      
      // Draw curve
      ctx.strokeStyle = curves[channel].color;
      ctx.lineWidth = 2;
      ctx.beginPath();
      
      const points = curves[channel].points;
      points.sort((a, b) => a.x - b.x);
      
      // Scale points to canvas dimensions
      const scaledPoints = points.map(p => ({
        x: (p.x / 255) * width,
        y: height - (p.y / 255) * height
      }));
      
      // Draw smooth curve through points
      if (scaledPoints.length > 1) {
        ctx.moveTo(scaledPoints[0].x, scaledPoints[0].y);
        
        for (let i = 1; i < scaledPoints.length; i++) {
          const xc = (scaledPoints[i].x + scaledPoints[i - 1].x) / 2;
          const yc = (scaledPoints[i].y + scaledPoints[i - 1].y) / 2;
          ctx.quadraticCurveTo(scaledPoints[i - 1].x, scaledPoints[i - 1].y, xc, yc);
        }
        
        ctx.lineTo(scaledPoints[scaledPoints.length - 1].x, scaledPoints[scaledPoints.length - 1].y);
      }
      
      ctx.stroke();
      
      // Draw control points
      ctx.fillStyle = curves[channel].color;
      scaledPoints.forEach(p => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, 5, 0, Math.PI * 2);
        ctx.fill();
        ctx.strokeStyle = 'white';
        ctx.lineWidth = 1;
        ctx.stroke();
      });
    }

    // Setup curve editing
    function setupCurveEditing(channel) {
      const canvas = curveCanvases[channel];
      let isDragging = false;
      let draggedPoint = null;
      
      canvas.addEventListener('mousedown', (e) => {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const width = canvas.width;
        const height = canvas.height;
        
        // Check if clicking near a point
        const points = curves[channel].points;
        for (let i = 0; i < points.length; i++) {
          const scaledX = (points[i].x / 255) * width;
          const scaledY = height - (points[i].y / 255) * height;
          
          if (Math.sqrt((x - scaledX) ** 2 + (y - scaledY) ** 2) < 10) {
            isDragging = true;
            draggedPoint = i;
            
            // If right-clicking, delete the point (but keep first and last)
            if (e.button === 2 && i !== 0 && i !== points.length - 1) {
              e.preventDefault();
              points.splice(i, 1);
              drawCurve(channel);
              updateImageWithAllAdjustments();
              return;
            }
            
            return;
          }
        }
        
        // Add new point if not near existing points
        const newX = Math.round((x / width) * 255);
        const newY = Math.round(255 - (y / height) * 255);
        
        // Don't add if too close to existing point on x-axis
        for (let i = 0; i < points.length; i++) {
          if (Math.abs(points[i].x - newX) < 10) return;
        }
        
        points.push({x: newX, y: newY});
        drawCurve(channel);
        updateImageWithAllAdjustments();
      });
      
      // Prevent context menu on right-click
      canvas.addEventListener('contextmenu', (e) => {
        e.preventDefault();
      });
      
      canvas.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const width = canvas.width;
        const height = canvas.height;
        
        const newX = Math.max(0, Math.min(255, Math.round((x / width) * 255)));
        const newY = Math.max(0, Math.min(255, Math.round(255 - (y / height) * 255)));
        
        curves[channel].points[draggedPoint] = {x: newX, y: newY};
        drawCurve(channel);
        updateImageWithAllAdjustments();
      });
      
      canvas.addEventListener('mouseup', () => {
        isDragging = false;
        draggedPoint = null;
      });
      
      canvas.addEventListener('mouseleave', () => {
        isDragging = false;
        draggedPoint = null;
      });
    }

    // Reset a curve to default
    function resetCurve(channel) {
      curves[channel].points = [{x: 0, y: 0}, {x: 255, y: 255}];
      drawCurve(channel);
      updateImageWithAllAdjustments();
    }

    // Apply curve adjustments to pixel data
    function applyCurve(pixelData, curvePoints) {
      // Create lookup table from curve points
      const lookupTable = createCurveLookupTable(curvePoints);
      
      // Apply lookup table to pixel data
      for (let i = 0; i < pixelData.length; i += 4) {
        pixelData[i] = lookupTable[pixelData[i]];       // R
        pixelData[i + 1] = lookupTable[pixelData[i + 1]]; // G
        pixelData[i + 2] = lookupTable[pixelData[i + 2]]; // B
      }
    }

    // Create lookup table from curve points
    function createCurveLookupTable(points) {
      const lookupTable = new Array(256);
      points.sort((a, b) => a.x - b.x);
      
      // Fill lookup table by interpolating between points
      for (let i = 0; i < points.length - 1; i++) {
        const start = points[i];
        const end = points[i + 1];
        const steps = end.x - start.x;
        
        for (let x = start.x; x <= end.x; x++) {
          const t = (x - start.x) / steps;
          lookupTable[x] = Math.round(start.y + t * (end.y - start.y));
        }
      }
      
      // Clamp values to 0-255
      for (let i = 0; i < 256; i++) {
        lookupTable[i] = Math.max(0, Math.min(255, lookupTable[i] || 0));
      }
      
      return lookupTable;
    }

    // Event listeners for color balance sliders
    redBalance.addEventListener('input', updateImageWithAllAdjustments);
    greenBalance.addEventListener('input', updateImageWithAllAdjustments);
    blueBalance.addEventListener('input', updateImageWithAllAdjustments);

    // Update display values when sliders change
    redBalance.addEventListener('input', () => redValue.textContent = redBalance.value);
    greenBalance.addEventListener('input', () => greenValue.textContent = greenBalance.value);
    blueBalance.addEventListener('input', () => blueValue.textContent = blueBalance.value);

    upload.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (event) {
        cropImage.src = event.target.result;
        previewContainer.style.display = 'block';
        if (cropper) cropper.destroy();

        // Store original image data for adjustments
        const img = new Image();
        img.onload = function() {
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        };
        img.src = event.target.result;

        // Set aspect ratio based on default specs
        const specs = defaultSpecs;
        const aspectRatio = specs.width / specs.height;

        cropper = new Cropper(cropImage, {
          aspectRatio: aspectRatio,
          viewMode: 1,
          autoCropArea: 0.8,
          responsive: true,
          guides: true,
          center: true,
          highlight: false,
          cropBoxMovable: true,
          cropBoxResizable: true,
          zoomOnTouch: false,
          zoomOnWheel: false,
          ready: function() {
            this.cropper.zoomTo(1);
            updateZoomDisplay();
          }
        });

        // Reset all adjustments when new image is loaded
        resetColorBalance();
        resetCurve('rgb');
      };
      reader.readAsDataURL(file);
    });

    function zoomIn() {
      if (cropper) {
        const currentZoom = cropper.getData().zoom || 1;
        if (currentZoom < 3) {
          cropper.zoom(0.1);
          updateZoomDisplay();
        }
      }
    }

    function zoomOut() {
      if (cropper) {
        const currentZoom = cropper.getData().zoom || 1;
        if (currentZoom > 0.5) {
          cropper.zoom(-0.1);
          updateZoomDisplay();
        }
      }
    }

    function updateZoomDisplay() {
      if (cropper) {
        const zoom = Math.round((cropper.getData().zoom || 1) * 100);
        document.getElementById('zoomLevel').textContent = `${zoom}%`;
      }
    }

    function rotateLeft() {
      if (cropper) cropper.rotate(-90);
    }

    function rotateRight() {
      if (cropper) cropper.rotate(90);
    }

    function resetColorBalance() {
      redBalance.value = 0;
      greenBalance.value = 0;
      blueBalance.value = 0;
      redValue.textContent = '0';
      greenValue.textContent = '0';
      blueValue.textContent = '0';
      
      updateImageWithAllAdjustments();
    }

    // Update image with all adjustments (color balance + curves)
    function updateImageWithAllAdjustments() {
      if (!cropper || !originalImageData) return;
      
      // Create a copy of the original image data
      const imageData = new ImageData(
        new Uint8ClampedArray(originalImageData.data),
        originalImageData.width,
        originalImageData.height
      );
      
      const data = imageData.data;
      
      // Apply color balance adjustments
      const red = parseInt(redBalance.value);
      const green = parseInt(greenBalance.value);
      const blue = parseInt(blueBalance.value);
      
      for (let i = 0; i < data.length; i += 4) {
        // Red/Cyan adjustment
        data[i] = clamp(data[i] + red * 2.55);
        data[i + 1] = clamp(data[i + 1] - red * 2.55);
        data[i + 2] = clamp(data[i + 2] - red * 2.55);
        
        // Green/Magenta adjustment
        data[i] = clamp(data[i] - green * 2.55);
        data[i + 1] = clamp(data[i + 1] + green * 2.55);
        data[i + 2] = clamp(data[i + 2] - green * 2.55);
        
        // Blue/Yellow adjustment
        data[i] = clamp(data[i] - blue * 2.55);
        data[i + 1] = clamp(data[i + 1] - blue * 2.55);
        data[i + 2] = clamp(data[i + 2] + blue * 2.55);
      }
      
      // Apply RGB curve (affects all channels)
      applyCurve(data, curves.rgb.points);
      
      // Create a canvas with the adjusted image
      const canvas = document.createElement('canvas');
      canvas.width = imageData.width;
      canvas.height = imageData.height;
      const ctx = canvas.getContext('2d');
      ctx.putImageData(imageData, 0, 0);
      
      // Update the cropper with the adjusted image
      cropper.replace(canvas.toDataURL());
    }
    
    function clamp(value) {
      return Math.max(0, Math.min(255, value));
    }

    function useCropped() {
      if (!cropper) {
        alert('Please upload and crop an image first.');
        return;
      }

      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      // Use default specs
      const specs = defaultSpecs;
      
      // Convert cm to pixels at 300 DPI (1 inch = 2.54cm, 300 DPI = 300 pixels per inch)
      const width = Math.round((specs.width / 2.54) * 300);
      const height = Math.round((specs.height / 2.54) * 300);
      
      canvas.width = width;
      canvas.height = height;

      const bgColor = document.getElementById('bgColorPicker').value;
      ctx.fillStyle = bgColor;
      ctx.fillRect(0, 0, width, height);

      const croppedCanvas = cropper.getCroppedCanvas({
        width: width,
        height: height,
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high'
      });

      ctx.drawImage(croppedCanvas, 0, 0, width, height);

      const finalImage = canvas.toDataURL('image/png');
      photoCanvas.innerHTML = '';
      previewContainer.style.display = 'none';

      // Create 8 photo slots (2 rows of 4 photos)
      for (let i = 0; i < 8; i++) {
        const div = document.createElement('div');
        div.className = 'photo-slot';
        const img = document.createElement('img');
        img.src = finalImage;
        img.alt = `Passport photo ${i+1}`;
        div.appendChild(img);
        photoCanvas.appendChild(div);
      }
      
      // Update size info text
      sizeInfo.textContent = `Standard 6x4 inches sheet with 8 passport photos (${specs.width} x ${specs.height} cm each, 300 DPI)`;
      
      // Scroll to the result section
      document.querySelector('.canvas-section').scrollIntoView({ behavior: 'smooth' });
    }

    function showDonationPopup() {
      // Create overlay
      const overlay = document.createElement('div');
      overlay.className = 'popup-overlay';
      
      // Create popup
      const popup = document.createElement('div');
      popup.className = 'donation-popup';
      popup.innerHTML = `
        <h3>Thank You for Using Our Software!</h3>
        <p>This software was created by a 12-year-old. If you'd like to support, please consider making a small donation.</p>
        
        <div class="donation-upi">
          UPI ID: 8504981410@fam
        </div>
        
        <div class="donation-amounts">
          <div class="donation-amount">₹5</div>
          <div class="donation-amount">₹10</div>
          <div class="donation-amount">₹20</div>
          <div class="donation-amount">₹50</div>
          <div class="donation-amount underline-blue">₹100</div>
        </div>
        
        <button class="close-popup" onclick="this.closest('.popup-overlay').remove()">
          Close
        </button>
      `;
      
      overlay.appendChild(popup);
      document.body.appendChild(overlay);
      
      // Close when clicking outside the popup
      overlay.addEventListener('click', function(e) {
        if (e.target === overlay) {
          overlay.remove();
        }
      });
    }

    function download() {
      if (photoCanvas.children.length === 0) {
        alert('Please create passport photos first by cropping and using an image.');
        return;
      }

      // Show loading state
      const downloadBtn = document.querySelector('button[onclick="download()"]');
      const originalText = downloadBtn.innerHTML;
      downloadBtn.innerHTML = '<div class="spinner"></div> Generating...';
      downloadBtn.disabled = true;

      html2canvas(photoCanvas, {
        scale: 3,
        backgroundColor: "#ffffff",
        useCORS: true,
        logging: false,
        allowTaint: true
      }).then(canvas => {
        const link = document.createElement('a');
        link.download = 'passport_photos_6x4_sheet.png';
        link.href = canvas.toDataURL('image/png');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Show donation popup after download
        showDonationPopup();

        // Restore button state
        downloadBtn.innerHTML = originalText;
        downloadBtn.disabled = false;
      }).catch(err => {
        console.error('Error generating image:', err);
        alert('Error generating image. Please try again.');
        downloadBtn.innerHTML = originalText;
        downloadBtn.disabled = false;
      });
    }

    function removeBackground() {
      if (!upload.files[0]) {
        alert('Please upload an image first.');
        return;
      }

      const apiKey = '9wEUsPtmrsxGrfHNTHiKzwGK';
      if (!apiKey) {
        alert('Background removal requires a valid API key. Please contact the developer.');
        return;
      }

      const removeBtn = document.querySelector('button[onclick="removeBackground()"]');
      const originalText = removeBtn.innerHTML;
      removeBtn.innerHTML = '<div class="spinner"></div> Processing...';
      removeBtn.disabled = true;

      const formData = new FormData();
      formData.append('image_file', upload.files[0]);
      formData.append('size', 'auto');

      fetch('https://api.remove.bg/v1.0/removebg', {
        method: 'POST',
        headers: {
          'X-Api-Key': apiKey
        },
        body: formData
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Background removal failed. API limit may be reached.');
        }
        return response.blob();
      })
      .then(blob => {
        const url = URL.createObjectURL(blob);
        cropImage.src = url;
        if (cropper) cropper.destroy();
        
        // Set aspect ratio based on default specs
        const specs = defaultSpecs;
        const aspectRatio = specs.width / specs.height;
        
        cropper = new Cropper(cropImage, {
          aspectRatio: aspectRatio,
          viewMode: 1,
          autoCropArea: 0.8,
          responsive: true,
          zoomOnTouch: false,
          zoomOnWheel: false
        });
        
        removeBtn.innerHTML = originalText;
        removeBtn.disabled = false;
        
        // Store the original image data for adjustments
        const img = new Image();
        img.onload = function() {
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        };
        img.src = url;
      })
      .catch(error => {
        console.error('Background removal error:', error);
        alert(error.message || 'Failed to remove background. Please try again.');
        removeBtn.innerHTML = originalText;
        removeBtn.disabled = false;
      });
    }

    // Initialize the app
    window.onload = function() {
      initCurveCanvases();
    };
  </script>
</body>
</html>